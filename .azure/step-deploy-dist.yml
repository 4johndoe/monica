steps:
- task: DownloadSecureFile@1
  displayName: Download secure file
  name: monicakey
  inputs:
    secureFile: 'monica_key.asc'

- script: echo "$(GPG_PASSPHRASE)" | gpg --batch --yes --passphrase-fd 0 --import $(monicakey.secureFilePath)
  displayName: Import key
  env:
    GPG_PASSPHRASE: $(gpg.passphrase)

- bash: |
    VERSION=$(php artisan monica:getversion)
    echo "Monica version: $VERSION"
    echo "##vso[task.setvariable variable=MONICA_VERSION]$VERSION"
  displayName: Set Monica version

- script: |
    scripts/ci/packages.sh 'v$(MONICA_VERSION)'
  displayName: Create dist files
- publish: $(package)
  artifact: package
- publish: $(assets)
  artifact: assets

- bash: |
    sha512sum $(package) > $(package).sha512
    sha512sum $(assets) > $(assets).sha512
    for f in '$(package){,.sha512}' '$(assets){,.sha512}'; do
      echo "Signing '$f'..."
      echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode=loopback --local-user $GPG_FINGERPRINT --sign --armor --output $f.asc --detach-sig $f
      echo -e "\nSigned with key fingerprint $GPG_FINGERPRINT" >> $f.asc
    done
  displayName: Sign files
  env:
    GPG_PASSPHRASE: $(gpg.passphrase)

- bash: |
    for f in '$(package){,.asc,.sha512,.sha512.asc}' '$(assets){,.asc,.sha512,.sha512.asc}'; do
      echo "Uploading release file '$f'..."
      gh release upload 'v$(MONICA_VERSION)' "$f" --clobber
    done
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)
